# Spring

## 事务的管理
    1. 在我们之前的account案例中完成一个transfer的转账操作
        <1> 即我们需要添加一个转账的操作(详细请参考spring_account_xmlioc_transfer)

        <2> 当我们在实现了一个转账的具体流程之后，进行测试发现，当我们在业务层出现一个异常时，会导致转账出现数据不
            匹配的问题。也就是转出账户少钱，但是目标账户没有多钱

        <3> 那么，出现这个问题的原因是：我们在业务层中并不是通过一个连接来完成对整个transfer操作的控制。而是使用了
            4个连接完成的。如果，在一个连接之前出现异常，那么后面的事务控制就会失败。不能够提交事务。如下所示

<img src="./img/img16.png" width = 800px>

        <4> 所以我们需要使用一个连接对事务进行控制，也就是将事务从持久层转到业务层，完成所有操作。
            1) 定义获取连接的工具类(ConnectionUtils)

            2) 定义控制事务的工具类(TransactionManager)
                * 问题：在事务控制时，我们的释放资源的方法，其实是将获取到的连接返回连接池中，那么在ConnectionUtils
                        中调用getThreadConnection再次获取链接时，是存在连接的，只不过被关闭了。不能够再使用

                * 解决：在ConnectionUtils中定义一个将线程与连接解绑的方法，然后再释放资源后，并调用该方法，将线程
                        与连接解绑

            3) 在业务层完成执行逻辑的编写

            4) 在完成之执行逻辑之后，我们需要明白之前我们是注入过数据源的，而我们在使用工具类是不需要使用注入的数据源
               的。所以需要去除,那么在dao实现类中就没有了datasource

<img src="./img/img17.png" width = 800px>

            5) 由于没有了注入的dataSource所以就没有连接，那么我们就需要注入ConnctionUtils，获取连接，然后在dao调用
               方法时，使用带有connection连接的方法完成增删改查

            6) 在bean.xml中注入其它需要注入数据的内容

## spring中的动态代理
    1. 动态代理概述
        * 特点：字节码随用随创建，随用随加载
        
        * 作用：不修改源码的基础上对方法增强
        
        * 分类：
            1) 基于接口的动态代理
            2) 基于子类的动态代理
          
    2. 基于接口的动态代理
        <1> 涉及的类：Proxy
        
        <2> 提供者：JDK官方

        <3> 如何创建代理对象：
            使用Proxy类中的newProxyInstance方法

        <4> 创建代理对象的要求：
            被代理类最少实现一个接口，如果没有则不能使用
            
        <5> newProxyInstance方法的参数：
            ClassLoader：类加载器
                它是用于加载代理对象字节码的。和被代理对象使用相同的类加载器。固定写法。

            Class[]：字节码数组
                它是用于让代理对象和被代理对象有相同方法。固定写法。

            InvocationHandler：用于提供增强的代码
                它是让我们写如何代理。我们一般都是些一个该接口的实现类，通常情况下都是匿名内部类，但不是必须的。
                此接口的实现类都是谁用谁写。

    3. 基于子类的动态代理：
        <1> 涉及的类：Enhancer

        <2> 提供者：第三方cglib库

        <3> 如何创建代理对象：
            使用Enhancer类中的create方法

        <4>创建代理对象的要求：
            被代理类不能是最终类

        <5> create方法的参数：
            Class：字节码
                它是用于指定被代理对象的字节码。
    
            Callback：用于提供增强的代码
                它是让我们写如何代理。我们一般都是些一个该接口的实现类，通常情况下都是匿名内部类，但不是必须的。
                此接口的实现类都是谁用谁写。
                我们一般写的都是Callback接口的子接口实现类：MethodInterceptor



